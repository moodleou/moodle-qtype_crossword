define("qtype_crossword/crossword_grid",["exports","qtype_crossword/crossword_question","./crossword_clue"],(function(_exports,_crossword_question,_crossword_clue){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.CrosswordGrid=void 0;
/**
   * CrosswordGrid class handle every function relative to grid.
   *
   * @module qtype_crossword/crossword_grid
   * @copyright 2022 The Open University
   * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */
class CrosswordGrid extends _crossword_question.CrosswordQuestion{constructor(options){super(options)}buildBackgroundTable(){let{colsNum:colsNum,rowsNum:rowsNum,previewSetting:previewSetting}=this.options,style=previewSetting;const tableEl=document.createElement("table");colsNum++,rowsNum++,tableEl.className="crossword-grid",tableEl.style.backgroundColor=style.backgroundColor;for(let i=0;i<rowsNum;i++){const rowEl=document.createElement("tr");rowEl.className="grid-row";for(let j=0;j<colsNum;j++){let squareEl=document.createElement("td");squareEl.className="grid-square",squareEl.style.borderColor=style.borderColor,squareEl.style.color=style.color,0===i&&0===j&&squareEl.classList.add("cell-white"),0===i&&0!==j&&(squareEl.innerText=this.getColumnLabel(j),squareEl.classList.add("square-indicate-horizontal")),0!==i&&0===j&&(squareEl.innerText=i,squareEl.classList.add("square-indicate-vertical")),rowEl.append(squareEl)}tableEl.append(rowEl)}this.tableEl=tableEl,this.options.crosswordEl.innerHTML=tableEl.outerHTML}addCell(){let{words:words,previewSetting:previewSetting,rowsNum:rowsNum,colsNum:colsNum}=this.options;if(0!==words.length)for(let i=0;i<words.length;i++){let row=words[i].startrow+1,column=words[i].startcolumn+1,answerLength=words[i].answer.length,realLength=answerLength+words[i].startcolumn,allowLength=parseInt(colsNum),invalidWord=""===words[i].clue.trim();row++,column++,invalidWord||(invalidWord=this.isInvalidAnswer(words[i].answer)),words[i].orientation&&(realLength=answerLength+words[i].startrow,allowLength=parseInt(rowsNum));for(let j=0;j<words[i].answer.length;j++){var _words$i$answer$j$toU;const number=i+1,squareEl=document.querySelector(".grid-row:nth-child("+row+") .grid-square:nth-child("+column+")");if(!squareEl)continue;if(squareEl.classList.add("background-white"),0===j){const labelEl=squareEl.querySelector(".word-label");if(labelEl){var _ref,_words$i2;let label=labelEl.innerText;label+=null!==(_ref=", "+(null===(_words$i2=words[i])||void 0===_words$i2?void 0:_words$i2.no))&&void 0!==_ref?_ref:number,labelEl.innerText=label}else{var _words$i$no,_words$i;let spanEl=document.createElement("span");spanEl.className="word-label",spanEl.innerText=null!==(_words$i$no=null===(_words$i=words[i])||void 0===_words$i?void 0:_words$i.no)&&void 0!==_words$i$no?_words$i$no:number,squareEl.append(spanEl)}}const letter=null!==(_words$i$answer$j$toU=words[i].answer[j].toUpperCase().trim())&&void 0!==_words$i$answer$j$toU?_words$i$answer$j$toU:"",contentEl=squareEl.querySelector("span.word-content");if(contentEl){let text="";const innerText=contentEl.innerText;innerText.search(letter)<0&&(text=innerText+" | "+letter,squareEl.style.backgroundColor=previewSetting.conflictColor,contentEl.innerText=text)}else{let spanEl=document.createElement("span");spanEl.className="word-content",spanEl.innerText=letter,squareEl.append(spanEl)}(invalidWord||realLength>allowLength)&&(squareEl.style.backgroundColor=previewSetting.conflictColor),words[i].orientation?row++:column++}}}previewCrossword(){this.buildBackgroundTable(),this.addCell()}buildCrossword(){const options=this.options;this.options={...options,width:32*options.colsNum+1,height:32*options.rowsNum+1};new _crossword_clue.CrosswordClue(this.options).setUpClue(),this.drawCrosswordSVG(),this.syncDataForInit(),this.addEventResizeScreen()}drawCrosswordSVG(){const options=this.options,crosswordEl=this.options.crosswordEl;if(!crosswordEl)return;let svg=this.createElementNSFrom("svg",{class:"crossword-grid",viewBox:"0 0 ".concat(options.width," ").concat(options.height)});const rectEl=this.createElementNSFrom("rect",{class:"crossword-grid-background",x:0,y:0,width:options.width,height:options.height});svg.append(rectEl),svg=this.createCrosswordBody(svg);const inputContainEl=this.createElementFrom("div",{class:"crossword-hidden-input-wrapper"}),inputEl=this.createElementFrom("input",{type:"text",class:"crossword-hidden-input",maxlength:1,autocomplete:"off",spellcheck:!1,autocorrect:"off"});this.addEventForWordInput(inputEl),inputContainEl.append(inputEl),crosswordEl.append(svg,inputContainEl)}createElementNSFrom(type){let attributes=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const element=document.createElementNS("http://www.w3.org/2000/svg",type);for(let key in attributes)element.setAttributeNS(null,key,attributes[key]);return element}createElementFrom(type){let attributes=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const element=document.createElement(type);for(let key in attributes)element.setAttribute(key,attributes[key]);return element}createCrosswordBody(svg){const{words:words,cellWidth:cellWidth,cellHeight:cellHeight}=this.options;let count=0;for(let i in words){const word=words[i];for(let key=0;key<word.length;key++){const customAttribute={startRow:word.startRow,startColumn:word.startColumn,letterIndex:key,word:"("+word.number+")",code:"A"+count},position=this.calculatePosition(word,parseInt(key)),rectEl=this.createElementNSFrom("rect",{...position,width:cellWidth,height:cellHeight,class:"crossword-cell"});let g=this.createElementNSFrom("g",{...customAttribute});const existingRectElement=svg.querySelector("rect.crossword-cell[x='".concat(position.x,"'][y='").concat(position.y,"']")),textEl=this.createElementNSFrom("text",{x:position.x+11,y:position.y+21,class:"crossword-cell-text"});if(existingRectElement){let g,existingNumberElement=existingRectElement.closest("g").querySelector("text.crossword-cell-number"),currentWord=existingRectElement.closest("g").getAttribute("word");existingRectElement.closest("g").setAttributeNS(null,"word",currentWord+"("+word.number+")"),0===parseInt(key)&&(existingNumberElement?existingNumberElement.append(", "+word.number):(g=existingRectElement.closest("g"),this.appendCellNumber(g,position,word.number)))}else g.append(rectEl),0===parseInt(key)&&(g=this.appendCellNumber(g,position,word.number)),g.append(textEl),this.addEventForG(g),count++,svg.append(g)}}return svg}appendCellNumber(g,position,wordNumber){const x=position.x+1,y=position.y+9;let textNumber=this.createElementNSFrom("text",{x:x,y:y,class:"crossword-cell-number"});return textNumber.append(wordNumber),g.append(textNumber),g}addEventForG(g){const{readonly:readonly}=this.options;readonly||g.addEventListener("click",(e=>{const inputEl=this.options.crosswordEl.querySelector(".crossword-hidden-input-wrapper").querySelector("input");let element=e.target;"g"!==element.tagName&&(element=element.closest("g")),this.handleWordSelect(element),inputEl.setAttributeNS(null,"code",element.getAttributeNS(null,"code")),inputEl.value="",this.updatePositionForCellInput(element.querySelector("rect")),inputEl.focus()}))}handleWordSelect(gEl){const currentCell=gEl.getAttributeNS(null,"code");let words=gEl.getAttributeNS(null,"word"),focus=-1,{coordinates:coordinates,wordNumber:wordNumber}=this.options;if(words=words.match(/(\d+)/g),currentCell===coordinates){const indexCell=words.indexOf(wordNumber);focus=void 0!==words[indexCell+1]?words[indexCell+1]:words[0]}else this.options.coordinates=currentCell,wordNumber<0&&(this.options.wordNumber=words[0]),focus=words.includes(wordNumber)?wordNumber:words[0];this.options.wordNumber=focus;const word=this.options.words.find((o=>o.number===parseInt(focus)));word&&(this.updateLetterIndexForCells(word),this.toggleHighlight(word,gEl),this.focusClue(),this.setStickyClue())}updatePositionForCellInput(){let rectEl=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(null===rectEl&&(rectEl=this.options.crosswordEl.querySelector("rect.crossword-cell-focussed")),rectEl){const rect=rectEl.getBoundingClientRect(),parentEl=this.options.crosswordEl.querySelector(".crossword-grid").getBoundingClientRect(),inputWrapperEl=this.options.crosswordEl.querySelector(".crossword-hidden-input-wrapper");let top=rect.top-parentEl.top;top<1&&(top=1),inputWrapperEl.style.cssText="\n                display: block; top: ".concat(top,"px;\n                left: ").concat(rect.left-parentEl.left,"px;\n                width: ").concat(rect.width,"px;\n                height: ").concat(rect.height,"px\n            ")}}addEventForWordInput(inputEl){const{readonly:readonly}=this.options;readonly||(inputEl.addEventListener("keypress",(e=>{e.preventDefault();const{wordNumber:wordNumber}=this.options,code=e.target.getAttributeNS(null,"code");let value=e.key.toUpperCase();if(""===this.replaceText(e.key))return!1;if(code){const textEl=this.options.crosswordEl.querySelector("g[code='".concat(code,"'] text.crossword-cell-text"));if(!textEl)return!1;textEl.innerHTML=value;const letterIndex=parseInt(textEl.closest("g").getAttributeNS(null,"letterIndex")),nextCellEl=this.options.crosswordEl.querySelector("g[word*='(".concat(wordNumber,")'][letterIndex='").concat(letterIndex+1,"']"));this.bindDataToClueInput(textEl.closest("g"),e.key),nextCellEl&&nextCellEl.dispatchEvent(new Event("click"))}})),inputEl.addEventListener("keyup",(event=>{event.preventDefault();const{wordNumber:wordNumber,cellWidth:cellWidth,cellHeight:cellHeight}=this.options,{key:key,target:target}=event,code=target.getAttributeNS(null,"code"),gEl=this.options.crosswordEl.querySelector("g[code='".concat(code,"']")),letterIndex=parseInt(gEl.getAttributeNS(null,"letterIndex")),previousCell=this.options.crosswordEl.querySelector("g[word*='(".concat(wordNumber,")'][letterIndex='").concat(letterIndex-1,"']")),textEl=gEl.querySelector("text.crossword-cell-text");let x=parseInt(gEl.querySelector("rect").getAttributeNS(null,"x")),y=parseInt(gEl.querySelector("rect").getAttributeNS(null,"y"));if(key!==this.DELETE&&key!==this.BACKSPACE||(""===textEl.innerHTML?previousCell&&previousCell.dispatchEvent(new Event("click")):(textEl.innerHTML="",this.bindDataToClueInput(gEl,"_"))),[this.ARROW_UP,this.ARROW_DOWN,this.ARROW_LEFT,this.ARROW_RIGHT].includes(key)){key===this.ARROW_UP&&(y-=cellHeight+1),key===this.ARROW_DOWN&&(y+=cellHeight+1),key===this.ARROW_LEFT&&(x-=cellWidth+1),key===this.ARROW_RIGHT&&(x+=cellWidth+1);const nextCell=this.options.crosswordEl.querySelector("g rect[x='".concat(x,"'][y='").concat(y,"']"));nextCell&&nextCell.closest("g").dispatchEvent(new Event("click"))}})),inputEl.addEventListener("click",(e=>{const code=e.target.getAttributeNS(null,"code"),gEl=this.options.crosswordEl.querySelector("g[code='".concat(code,"']"));this.handleWordSelect(gEl)})),inputEl.addEventListener("keydown",(e=>{let{key:key}=e;key=key.toLowerCase(),e.ctrlKey&&(key!==this.Z_KEY&&key!==this.A_KEY||e.preventDefault()),e.key===this.ENTER&&e.preventDefault()})),inputEl.addEventListener("paste",(e=>{e.preventDefault()})))}addEventResizeScreen(){window.addEventListener("resize",(()=>{this.updatePositionForCellInput()}))}}_exports.CrosswordGrid=CrosswordGrid}));

//# sourceMappingURL=crossword_grid.min.js.map